{% extends "base.html" %}
{% block title %}Evidence - {{ project.name }} - Strategizer{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/api/strategizer/ui/">Projects</a></li>
            <li class="breadcrumb-item"><a href="/api/strategizer/ui/projects/{{ project.id }}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">Evidence</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Left: Sources -->
        <div class="col-md-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="bi bi-journal-text"></i> Sources</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addSourceModal">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>

            {% if sources %}
            {% for source in sources %}
            <div class="card evidence-source mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h6 class="mb-1">{{ source.source_name }}</h6>
                        <span class="badge bg-info">{{ source.source_type }}</span>
                    </div>
                    <small class="text-muted">{{ source.created_at.strftime('%b %d, %Y') }}</small>

                    <div class="mt-2">
                        {% if source.extraction_status == 'extracted' %}
                        <span class="badge bg-success">{{ source.extracted_count }} fragments</span>
                        {% elif source.extraction_status == 'pending' %}
                        <button class="btn btn-sm btn-warning" onclick="extractSource('{{ source.id }}')">
                            <i class="bi bi-cpu"></i> Extract
                        </button>
                        {% elif source.extraction_status == 'extracting' %}
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-hourglass-split"></i> Extracting...
                        </span>
                        {% else %}
                        <span class="badge bg-danger">{{ source.extraction_status }}</span>
                        {% endif %}
                    </div>

                    {% if source.fragment_counts %}
                    <div class="mt-2 small">
                        {% if source.fragment_counts.get('PENDING') %}
                        <span class="badge badge-pending">{{ source.fragment_counts.PENDING }} pending</span>
                        {% endif %}
                        {% if source.fragment_counts.get('NEEDS_DECISION') %}
                        <span class="badge badge-needs-decision">{{ source.fragment_counts.NEEDS_DECISION }} need decision</span>
                        {% endif %}
                        {% if source.fragment_counts.get('INTEGRATED') %}
                        <span class="badge badge-integrated">{{ source.fragment_counts.INTEGRATED }} integrated</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <i class="bi bi-file-earmark-plus"></i>
                <p>No sources yet</p>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSourceModal">
                    Add Source
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Right: Fragments -->
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="bi bi-puzzle"></i> Recent Fragments</h5>
                {% if pending_decisions > 0 %}
                <a href="/api/strategizer/ui/projects/{{ project.id }}/decisions" class="btn btn-warning btn-sm">
                    <i class="bi bi-exclamation-triangle"></i> {{ pending_decisions }} need decisions
                </a>
                {% endif %}
            </div>

            {% if fragments %}
            <div class="list-group">
                {% for fragment in fragments %}
                <div class="list-group-item evidence-fragment {{ fragment.status|lower|replace('_', '-') }}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="mb-1">{{ fragment.content }}</p>
                            <small class="text-muted">{{ fragment.created_at.strftime('%b %d, %H:%M') }}</small>
                        </div>
                        <div class="text-end ms-3">
                            {% if fragment.status == 'PENDING' %}
                            <span class="badge badge-pending">Pending</span>
                            {% elif fragment.status == 'ANALYZED' %}
                            <span class="badge bg-info">Analyzed</span>
                            {% elif fragment.status == 'NEEDS_DECISION' %}
                            <span class="badge badge-needs-decision">Needs Decision</span>
                            {% elif fragment.status == 'INTEGRATED' %}
                            <span class="badge badge-integrated">Integrated</span>
                            {% elif fragment.status == 'REJECTED' %}
                            <span class="badge bg-secondary">Rejected</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ fragment.status }}</span>
                            {% endif %}
                            {% if fragment.confidence %}
                            <br><small class="{{ 'confidence-high' if fragment.confidence >= 0.85 else ('confidence-medium' if fragment.confidence >= 0.6 else 'confidence-low') }}">
                                {{ (fragment.confidence * 100)|int }}% confidence
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="analyzeNextFragment()">
                    <i class="bi bi-cpu"></i> Analyze Next Fragment
                </button>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-puzzle"></i>
                <h5>No fragments yet</h5>
                <p>Add a source and extract fragments to start building evidence.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Source Modal -->
<div class="modal fade" id="addSourceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Evidence Source</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addSourceForm">
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#manualTab">
                                <i class="bi bi-pencil"></i> Manual
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#urlTab">
                                <i class="bi bi-link-45deg"></i> URL
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="manualTab">
                            <div class="mb-3">
                                <label class="form-label">Source Name</label>
                                <input type="text" class="form-control" id="manualSourceName"
                                       placeholder="e.g., Interview with Expert A">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Content</label>
                                <textarea class="form-control" id="manualSourceContent" rows="10"
                                          placeholder="Paste or type the source content here..."></textarea>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="urlTab">
                            <div class="mb-3">
                                <label class="form-label">URL</label>
                                <input type="url" class="form-control" id="urlSource"
                                       placeholder="https://example.com/article">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Source Name (optional)</label>
                                <input type="text" class="form-control" id="urlSourceName"
                                       placeholder="Will be auto-detected if not provided">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Add Source
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const projectId = '{{ project.id }}';

function getStatusBadge(status) {
    const badges = {
        'PENDING': '<span class="badge badge-pending">Pending</span>',
        'ANALYZED': '<span class="badge bg-info">Analyzed</span>',
        'NEEDS_DECISION': '<span class="badge badge-needs-decision">Needs Decision</span>',
        'INTEGRATED': '<span class="badge badge-integrated">Integrated</span>',
        'REJECTED': '<span class="badge bg-secondary">Rejected</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

async function extractSource(sourceId) {
    try {
        await API.extractSource(projectId, sourceId);
        Toast.success('Extraction started!');
        location.reload();
    } catch (error) {
        Toast.error('Failed to extract: ' + error.message);
    }
}

async function analyzeNextFragment() {
    try {
        // Get pending fragments
        const fragments = await API.getFragments(projectId, 'PENDING');
        if (!fragments.length) {
            Toast.info('No pending fragments to analyze');
            return;
        }

        // Analyze first one
        const fragment = fragments[0];
        await API.analyzeFragment(projectId, fragment.id, {});
        Toast.success('Fragment analyzed!');
        location.reload();
    } catch (error) {
        Toast.error('Failed to analyze: ' + error.message);
    }
}

function initPage() {
    document.getElementById('addSourceForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const activeTab = document.querySelector('#addSourceModal .tab-pane.active');
        let sourceData = {};

        if (activeTab.id === 'manualTab') {
            sourceData = {
                source_type: 'manual',
                source_name: document.getElementById('manualSourceName').value,
                source_content: document.getElementById('manualSourceContent').value
            };
        } else {
            sourceData = {
                source_type: 'url',
                source_name: document.getElementById('urlSourceName').value || null,
                source_content: document.getElementById('urlSource').value
            };
        }

        try {
            await API.addSource(projectId, sourceData);
            Toast.success('Source added!');
            bootstrap.Modal.getInstance(document.getElementById('addSourceModal')).hide();
            location.reload();
        } catch (error) {
            Toast.error('Failed to add source: ' + error.message);
        }
    });
}
</script>
{% endblock %}
